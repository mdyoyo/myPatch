<!DOCTYPE html>
<html lang="ch-ZN">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />
    <title>个人信息</title>

    <meta name="description" content="Common form elements and layouts" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

    <!-- bootstrap & fontawesome -->
    <link rel="stylesheet" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" href="/assets/css/font-awesome.css" />

    <!-- page specific plugin styles -->
    <link rel="stylesheet" href="/assets/css/jquery-ui.custom.css" />
    <link rel="stylesheet" href="/assets/css/chosen.css" />
    <!-- text fonts -->
    <link rel="stylesheet" href="/assets/css/ace-fonts.css" />
    <link rel="stylesheet" href="/css/common.css">
    <!-- ace styles -->
    <link rel="stylesheet" href="/assets/css/ace.css" class="ace-main-stylesheet" id="main-ace-style" />
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/assets/css/ace-part2.css" class="ace-main-stylesheet" />
    <![endif]-->
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/assets/css/ace-ie.css" />
    <![endif]-->

    <!-- inline styles related to this page -->

    <!-- ace settings handler -->
    <script src="/assets/js/ace-extra.js"></script>

    <!-- HTML5shiv and Respond.js for IE8 to support HTML5 elements and media queries -->

    <!--[if lte IE 8]>
    <script src="/assets/js/html5shiv.js"></script>
    <script src="/assets/js/respond.js"></script>
    <![endif]-->
</head>
<body class="no-skin">
<!-- #section:basics/navbar.layout -->
<%- include ../templates/topbar_nav %>
<!-- /section:basics/navbar.layout -->
<div class="main-container" id="main-container">
    <script type="text/javascript">
        try{ace.settings.check('main-container' , 'fixed')}catch(e){}
    </script>
    <!-- #section:basics/sidebar -->
    <%- include ../templates/sidebar_nav %>
    <!-- /section:basics/sidebar -->
    <div class="main-content">
        <div class="main-content-inner">
            <div class="page-content">
                <div class="page-header">
                    <h1>个人信息</h1>
                </div><!-- /.page-header -->
                <div class="row">
                    <div class="col-xs-12">
                        <form class="form-horizontal" role="form">
                            <!-- #section:elements.form -->
                            <% if(!showEdit) { %>
                            <div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right"
                                       for="form-field-1">用户名</label>
                                <div class="col-sm-9">
                                    <input readonly type="text" id="form-field-1" class="col-xs-10 col-sm-5"
                                            value="<%= user.username %>">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right" for="form-field-1-1">
                                    权限</label>
                                <div class="col-sm-9">
                                    <input readonly type="text" id="form-field-1-1"
                                           value="<%= user.level === 0 ? '普通用户组' : '高级用户组' %>" class="col-xs-10 col-sm-5">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label no-padding-right" for="form-field-1-1">
                                    状态</label>
                                <div class="col-sm-9">
                                    <input readonly type="text" id="form-field-1-1"
                                           value="<%= user.status === 0 ? '正常' : '关闭' %>" class="col-xs-10 col-sm-5">
                                </div>
                            </div>
                            <% } else {%>
                            <div class="clearfix form-actions">
                                <input style="display: none;" value="<%= user.username %>" id="username">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label no-padding-right" for="form-field-2">输入旧密码</label>
                                    <div class="col-sm-9">
                                        <input type="password" id="OLDPWD" placeholder="Password"
                                               class="col-xs-10 col-sm-5" name="oldPwd"
                                               onblur="check(this)" onfocus="change_hint(this)">
											<span class="help-inline col-xs-12 col-sm-7">
												<span class="middle" id="oldPwd_hint"></span>
											</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label no-padding-right" for="form-field-2">输入新密码</label>
                                    <div class="col-sm-9">
                                        <input type="password" id="NEWPWD" placeholder="Password" class="col-xs-10 col-sm-5"
                                               onblur="check(this)" onfocus="change_hint(this)" name="newPwd">
											<span class="help-inline col-xs-12 col-sm-7">
												<span class="middle" id="newPwd_hint"></span>
											</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label no-padding-right" for="form-field-2">确认新密码</label>
                                    <div class="col-sm-9">
                                        <input type="password" id="NEWPWDREPEAT" placeholder="Password" class="col-xs-10 col-sm-5"
                                               onblur="check(this)" onfocus="change_hint(this)" name="newPwdRepeat">
											<span class="help-inline col-xs-12 col-sm-7">
												<span class="middle" id="newPwdRepeat_hint"></span>
											</span>
                                    </div>
                                </div>
                                <div class="center">
                                    <button class="btn btn-info" type="button" onclick="changePwd();"
                                            id="submitBtn" disabled>
                                        <i class="ace-icon fa fa-check bigger-110"></i>
                                        确认修改
                                    </button>
                                </div>
                            </div>
                            <% } %>

                        </form>
                    </div>
                </div>
                <!-- /.row -->
            </div><!-- /.page-content -->
        </div>
    </div><!-- /.main-content -->

    <div class="footer">
        <div class="footer-inner">
            <!-- #section:basics/footer -->
            <div class="footer-content">
						<span class="bigger-120">
							<span class="blue bolder">王晨</span>
							北京大学软件与微电子学院
						</span>
            </div>

            <!-- /section:basics/footer -->
        </div>
    </div>

    <a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
        <i class="ace-icon fa fa-angle-double-up icon-only bigger-110"></i>
    </a>
</div><!-- /.main-container -->

<!-- basic scripts -->

<!--[if !IE]> -->
<script type="text/javascript">
    window.jQuery || document.write("<script src='/assets/js/jquery.js'>"+"<"+"/script>");
</script>

<!-- <![endif]-->

<!--[if IE]>
<script type="text/javascript">
    window.jQuery || document.write("<script src='/assets/js/jquery1x.js'>"+"<"+"/script>");
</script>
<![endif]-->
<script type="text/javascript">
    if('ontouchstart' in document.documentElement) document.write("<script src='/assets/js/jquery.mobile.custom.js'>"+"<"+"/script>");
</script>
<script src="/assets/js/bootstrap.js"></script>

<!-- page specific plugin scripts -->

<!--[if lte IE 8]>
<script src="/assets/js/excanvas.js"></script>
<![endif]-->
<script src="/assets/js/jquery-ui.custom.js"></script>
<script src="/assets/js/jquery.ui.touch-punch.js"></script>
<script src="/assets/js/chosen.jquery.js"></script>
<script src="/assets/js/jquery.knob.js"></script>
<script src="/assets/js/autosize.js"></script>
<script src="/assets/js/jquery.inputlimiter.1.3.1.js"></script>
<script src="/assets/js/jquery.maskedinput.js"></script>
<script src="/assets/js/bootstrap-tag.js"></script>

<!-- ace scripts -->
<script src="/assets/js/ace/elements.scroller.js"></script>
<script src="/assets/js/ace/elements.fileinput.js"></script>
<script src="/assets/js/ace/elements.typeahead.js"></script>
<script src="/assets/js/ace/elements.aside.js"></script>
<script src="/assets/js/ace/ace.js"></script>
<script src="/assets/js/ace/ace.ajax-content.js"></script>
<script src="/assets/js/ace/ace.touch-drag.js"></script>
<script src="/assets/js/ace/ace.sidebar.js"></script>
<script src="/assets/js/ace/ace.sidebar-scroll-1.js"></script>
<script src="/assets/js/ace/ace.submenu-hover.js"></script>
<script src="/assets/js/ace/ace.widget-box.js"></script>
<script src="/assets/js/ace/ace.widget-on-reload.js"></script>

<!-- inline scripts related to this page -->
<script type="text/javascript">
    jQuery(function($) {

        if(!ace.vars['touch']) {
            $('.chosen-select').chosen({allow_single_deselect:true});
            //resize the chosen on window resize

            $(window)
                    .off('resize.chosen')
                    .on('resize.chosen', function() {
                        $('.chosen-select').each(function() {
                            var $this = $(this);
                            $this.next().css({'width': $this.parent().width()});
                        })
                    }).trigger('resize.chosen');
        }
        $('[data-rel=tooltip]').tooltip({container:'body'});
        $('[data-rel=popover]').popover({container:'body'});

        autosize($('textarea[class*=autosize]'));

        $('textarea.limited').inputlimiter({
            remText: '%n character%s remaining...',
            limitText: 'max allowed : %n.'
        });

        $.mask.definitions['~']='[+-]';

        //dynamically change allowed formats by changing allowExt && allowMime function
    });
</script>
<script type="text/javascript">
    function changePwd() {
        var uname = $('#username').val();
        var pwd = $('#NEWPWD').val();
        var data = {
            "username": uname,
            "password": pwd
        };
        $.getJSON("edit_pwd", data,
                function (data) {
                    if (!data.status) {
                        alert( "修改失败,请重试" );
                    } else {
                        alert( "修改成功,请重新登录." );
                        window.location.href = '/login';
                    }
                });
    }
    function change_hint(obj) {
        var name = obj.name;
        var temp;
        if (name == "oldPwd") {
            temp = $("#oldPwd_hint");
            temp.className = "my_help_block";
            temp.innerHTML = "";
            temp.attr('checkPassed', 'false');
        } else if (name == "newPwd") {
            temp = $("#newPwd_hint");
            temp.className = "my_help_block";
            temp.innerHTML = "长度不少于6个字符，必须同时包含数字、小写字母、大写字母";
            temp.attr('checkPassed', 'false');
        } else if (name == "newPwdRepeat") {
            temp = $("#newPwdRepeat_hint");
            temp.className = "my_help_block";
            temp.innerHTML = "请确认与第一次输入的密码一致";
            temp.attr('checkPassed', 'false');
        }
    }
    function check(obj) {
        var id = obj.name;
        var text = document.getElementById(id.toUpperCase()).value;
        //判断是否为空
        if (text.replace(/\s/g, "") == "") {
            $('#' + id + "_hint").innerHTML = "输入不能为空";
            $('#submitBtn').attr('disabled', 'true');
        } else {
            if (id == "oldPwd") {
                checkOldPassword();
            } else if (id == "newPwd") {
                checkPassword();
            } else if (id == "newPwdRepeat") {
                checkPasswordRepeat();
            }
            checkSubmit();
        }
    }
    function checkOldPassword() {
        var uname = $('#username').val();
        var pwd = $('#OLDPWD').val();
        var temp = $("#oldPwd_hint");
        var data = {
            "username": uname,
            "password": pwd
        };
        $.getJSON("check_login", data,
                function (data) {
                    if (!(data.status)) {
                        temp.attr('checkPassed', 'false');
                        temp.html('密码错误');
                        temp.attr('class', 'my_register_check_hint_error')
                    } else {
                        temp.attr('class', "my_register_check_hint_ok");
                        temp.html("");
                        temp.attr('checkPassed', 'true');
                    }
                });
    }
    function checkPassword() {
        var password = $("#NEWPWD").val();
        var temp = $("#newPwd_hint");
        var r = /^(?=.*[0-9].*)(?=.*[A-Z].*)(?=.*[a-z].*).{6,20}$/;
        if (r.test(password)) {
            temp.attr('class', "my_register_check_hint_ok");
            temp.html("恭喜，输入正确");
            temp.attr('checkPassed', 'true');
        } else {
            temp.attr('class', "my_register_check_hint_error");
            if (password.length < 6) {
                temp.html("密码长度必须大于6个字符");
            } else {
                temp.html("密码必须同时包含数字、小写字母、大写字母");
            }
            temp.attr('checkPassed', 'false');
        }
    }
    function checkPasswordRepeat() {
        var password = $("#NEWPWD").val();
        var passwordRepeat = $("#NEWPWDREPEAT").val();
        var temp = $('#newPwdRepeat_hint');
        if (password != passwordRepeat) {
            temp.attr('class', "my_register_check_hint_error");
            temp.html("两次输入的密码不一致，请修改");
            temp.attr('checkPassed', 'false');
        } else {
            temp.attr('class', "my_register_check_hint_ok");
            temp.html("恭喜，输入正确");
            temp.attr('checkPassed', 'true');
        }
    }
    function checkSubmit() {
        var oldChecked = $('#oldPwd_hint').attr('checkPassed');
        var newChecked = $('#newPwd_hint').attr('checkPassed');
        var repeatChecked = $('#newPwdRepeat_hint').attr('checkPassed');
        var result = oldChecked && newChecked && repeatChecked;
        if (result === "true") {
            console.log('remove');
            $('#submitBtn').removeAttr("disabled");
        } else {
            console.log('set true');
            $('#submitBtn').attr("disabled", "true");
        }
    }
</script>
</body>
</html>
